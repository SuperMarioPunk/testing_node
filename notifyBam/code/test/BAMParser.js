'use strict';

const mochaPlugin = require('serverless-mocha-plugin');
const expect = mochaPlugin.chai.expect;
const BAMParser = require('../lib/BAMParser.js');
const schema = require('../lib/schemaData.json');

var validData = {};
var negativeString = "";
var positiveString = "";
var validString  = "";
function copy(data) {
    return JSON.parse(JSON.stringify(data));
}

describe('BAMParser', () => {
    describe('Format Data', () => {
        before((done) => {
            done();

            validData = {
                "seqNum": "1089",
                "agentIdent": "A2000",
                "posLocation": "0000001361",
                "trnDate": "072414",
                "trnTypeValue":"00000515454",
                "toAcctId":"00000000000000208005126",
                "fromAcctId": "00000000000000208005126",
                "curAmt": 2000,
                "memo": "HSBC*HSBC - C 6037429300000218 20140724",
                "acctBal": 982793,
                "scaDate": "07/24/14",
                "trnTime": "0515454"
            };
            validString =    "0000000000000000001089      07241400000000000000208005126                                                                                                                          00000000000000000000000002000N$                                                                                                                                                                                                                          00000000000000208005126                                               0000001361HSBC*HSBC - C 6037429300000218 20140724                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       A2000     0000000982793                  00000515454                                                      00000000000000000000000000000000000000000000000000000000000000000000000000000000                                                                                +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               07/24/14                                0515454                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ";
            negativeString = "0000000000000000001089      07241400000000000000208005126                                                                                                                          00000000000000000000000002000N$                                                                                                                                                                                                                          00000000000000208005126                                               0000001361HSBC*HSBC - C 6037429300000218 20140724                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       A2000     0000000000029                  00000515454                                                      00000000000000000000000000000000000000000000000000000000000000000000000000000000                                                                                -                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               07/24/14                                0515454                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ";
            positiveString = "0000000000000000001089      07241400000000000000208005126                                                                                                                          00000000000000000000000002000N$                                                                                                                                                                                                                          00000000000000208005126                                               0000001361HSBC*HSBC - C 6037429300000218 20140724                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       A2000     0000000000029                  00000515454                                                      00000000000000000000000000000000000000000000000000000000000000000000000000000000                                                                                +                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               07/24/14                                0515454                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         ";

        });
        it('null request', (done) => {
            BAMParser.format(null, (err, data) => {
                expect(err).to.equal('should be object');
                done();
            });
        });
        it('empty request', (done) => {
            BAMParser.format({}, (err, data) => {
                expect(err).to.equal("should have required property 'seqNum'");
                done();
            });
        });
        it('seqNum - required property ', (done) => {
            var data = copy(validData);
            delete data.seqNum;
            BAMParser.format(data, (err, data) => {
                expect(err).to.equal("should have required property 'seqNum'");
                done();
            });
        });
        it('seqNum - max length', (done) => {
            var data = copy(validData);
            data.seqNum = "100111100111";
            BAMParser.format(data, (err, data) => {
                expect(err).to.equal("should NOT be longer than 10 characters");
                done();
            });

        });
        it('seqNum - invalid type', (done) => {
            var data = copy(validData);
            data.seqNum =9999;
            BAMParser.format(data, (err, data) => {
                expect(err).to.equal("should be string");
                done();
            });

        });
        it('trnDate - required property', (done) => {
            var data = copy(validData);
            delete data.trnDate;
            BAMParser.format(data, (err, data) => {
                expect(err).to.equal("should have required property 'trnDate'");
                done();
            });
        });
        it('trnDate - max length', (done) => {
            var data = copy(validData);
            data.trnDate = "0108180";
            BAMParser.format(data, (err, data) => {
                expect(err).to.equal("should NOT be longer than 6 characters");
                done();
            });
        });
        it('trnDate - invalid type', (done) => {
            var data = copy(validData);
            data.trnDate = 10818;
            BAMParser.format(data, (err, data) => {
                expect(err).to.equal("should be string");
                done();
            });
        });

        it('peticion con valores minimos', (done) => {
            var vdata = copy(validData);
            BAMParser.format(vdata, (err, data) => {
                if (err) console.error(err);
                expect(data).to.equal(validString);
                expect(data.length).to.equal(11788);
                expect(err).to.be.null;
                done();
            });
        }); 
        it('peticion con saldo negativo', (done) => {
            var vdata = copy(validData);
            vdata.acctBal = -29;
            BAMParser.format(vdata, (err, data) => {
                if (err) console.error(err);
                expect(data).to.equal(negativeString);
                expect(data[1284]).to.equal('-');
                expect(err).to.be.null;
                done();
            });
        });
        it('peticion con saldo negativo', (done) => {
            var vdata = copy(validData);
            vdata.acctBal = 29;
            BAMParser.format(vdata, (err, data) => {
                if (err) console.error(err);
                expect(data).to.equal(positiveString);
                expect(data[1284]).to.equal('+');
                expect(err).to.be.null;
                done();
            });
        });
    });
    
    describe('Parser String', () => {
        before((done) => {
            done();
        });
        it('Invalid string less data', (done) => {
            BAMParser.parser(validString.slice(5, -1), (err, data) => {
                //if (err) console.error(err);
                expect(err).to.be.equal('Error parser less data.');
                done();
            });
        });
        it('Invalid string length', (done) => {
            BAMParser.parser(validString+'00', (err, data) => {
                //if (err) console.error(err);
                expect(err).to.be.equal('Error parser maxlength');
                done();
            });
        });
        it('Valid string', (done) => {
            BAMParser.parser(validString, (err, data) => {
                if (err) console.log(err);
                expect(err).to.be.null;
                expect(data.length).to.be.equal(Object.keys(schema.properties).length);
                done();
            });
        });
    });
    
});
